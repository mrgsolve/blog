<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kyle Baron">
<meta name="dcterms.date" content="2024-02-15">
<meta name="description" content="The evtools plugin is a set of functions and classes you can use to implement dosing regimens from inside your model. It first became available in mrgsolve 1.4.1.">

<title>Dynamic dosing with mrgsolve and evtools – mrgsolve/blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-122d777f2c3aea4cc84ab561bb62f904.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: white;
      }

      .quarto-title-block .quarto-title-banner {
        color: white;
background: #097f5f;
      }
</style>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Dynamic dosing with mrgsolve and evtools – mrgsolve/blog">
<meta property="og:description" content="The evtools plugin is a set of functions and classes you can use to implement dosing regimens from inside your model. It first became available in mrgsolve 1.4.1.">
<meta property="og:image" content="https://mrgsolve.org/blog/images/preview.png">
<meta property="og:site_name" content="mrgsolve/blog">
<meta name="twitter:title" content="Dynamic dosing with mrgsolve and evtools – mrgsolve/blog">
<meta name="twitter:description" content="The evtools plugin is a set of functions and classes you can use to implement dosing regimens from inside your model. It first became available in mrgsolve 1.4.1.">
<meta name="twitter:image" content="https://mrgsolve.org/blog/images/preview.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">mrgsolve/blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/user-guide"> 
<span class="menu-text">UserGuide</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/blog"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-vignette" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Vignette</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-vignette">    
        <li>
    <a class="dropdown-item" href="https://mrgsolve.org/vignette">
 <span class="dropdown-text">mrgsolve basics - html format</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mrgsolve.org/vignette/mrgsolve-vignette.pdf">
 <span class="dropdown-text">mrgsolve basics - pdf format</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/learn.html"> 
<span class="menu-text">Learn</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/docs"> 
<span class="menu-text">Docs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/mrgsolve/depot"> 
<span class="menu-text">Models</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-source" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Source</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-source">    
        <li>
    <a class="dropdown-item" href="https://github.com/metrumresearchgroup/mrgsolve">
 <span class="dropdown-text">GitHub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://cran.r-project.org/package=mrgsolve">
 <span class="dropdown-text">CRAN</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/metrumresearchgroup/mrgsolve/discussions">
 <span class="dropdown-text">Discuss</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/metrumresearchgroup/mrgsolve/issues">
 <span class="dropdown-text">Report an issue</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org"> 
<span class="menu-text">mrgsolve.org</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/metrumresearchgroup/mrgsolve"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mrgsolve"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Dynamic dosing with mrgsolve and evtools</h1>
                  <div>
        <div class="description">
          <p>The evtools plugin is a set of functions and classes you can use to implement dosing regimens from <em>inside</em> your model. It first became available in mrgsolve 1.4.1.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">dynamic-dosing</div>
                <div class="quarto-category">evtools</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Kyle Baron </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 15, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">2</span> Setup</a></li>
  <li><a href="#invoking-evtools" id="toc-invoking-evtools" class="nav-link" data-scroll-target="#invoking-evtools"><span class="header-section-number">3</span> Invoking <code>evtools</code></a></li>
  <li><a href="#everything-is-in-the-evt-namespace" id="toc-everything-is-in-the-evt-namespace" class="nav-link" data-scroll-target="#everything-is-in-the-evt-namespace"><span class="header-section-number">4</span> Everything is in the <code>evt</code> namespace</a></li>
  <li><a href="#functions-to-administer-single-doses-now" id="toc-functions-to-administer-single-doses-now" class="nav-link" data-scroll-target="#functions-to-administer-single-doses-now"><span class="header-section-number">5</span> Functions to administer single doses now</a>
  <ul class="collapse">
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example"><span class="header-section-number">5.1</span> Example</a></li>
  </ul></li>
  <li><a href="#functions-to-administer-single-customized-doses" id="toc-functions-to-administer-single-customized-doses" class="nav-link" data-scroll-target="#functions-to-administer-single-customized-doses"><span class="header-section-number">6</span> Functions to administer single, customized doses</a>
  <ul class="collapse">
  <li><a href="#functions-to-work-on-event-objects" id="toc-functions-to-work-on-event-objects" class="nav-link" data-scroll-target="#functions-to-work-on-event-objects"><span class="header-section-number">6.1</span> Functions to work on event objects</a></li>
  <li><a href="#be-sure-to-send-the-object-back-to-mrgsolve" id="toc-be-sure-to-send-the-object-back-to-mrgsolve" class="nav-link" data-scroll-target="#be-sure-to-send-the-object-back-to-mrgsolve"><span class="header-section-number">6.2</span> Be sure to send the object back to mrgsolve</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1"><span class="header-section-number">6.3</span> Example</a></li>
  </ul></li>
  <li><a href="#an-object-to-implement-a-full-dosing-regimen" id="toc-an-object-to-implement-a-full-dosing-regimen" class="nav-link" data-scroll-target="#an-object-to-implement-a-full-dosing-regimen"><span class="header-section-number">7</span> An object to implement a full dosing regimen</a>
  <ul class="collapse">
  <li><a href="#setting-up-a-regimen-object" id="toc-setting-up-a-regimen-object" class="nav-link" data-scroll-target="#setting-up-a-regimen-object"><span class="header-section-number">7.1</span> Setting up a <code>regimen</code> object</a></li>
  <li><a href="#initializing-the-regimen-object" id="toc-initializing-the-regimen-object" class="nav-link" data-scroll-target="#initializing-the-regimen-object"><span class="header-section-number">7.2</span> Initializing the <code>regimen</code> object</a></li>
  <li><a href="#setting-up-the-regimen-object" id="toc-setting-up-the-regimen-object" class="nav-link" data-scroll-target="#setting-up-the-regimen-object"><span class="header-section-number">7.3</span> Setting up the <code>regimen</code> object</a></li>
  <li><a href="#execute-the-regimen" id="toc-execute-the-regimen" class="nav-link" data-scroll-target="#execute-the-regimen"><span class="header-section-number">7.4</span> Execute the regimen</a></li>
  <li><a href="#example-2" id="toc-example-2" class="nav-link" data-scroll-target="#example-2"><span class="header-section-number">7.5</span> Example</a></li>
  <li><a href="#update-the-dose-regimen" id="toc-update-the-dose-regimen" class="nav-link" data-scroll-target="#update-the-dose-regimen"><span class="header-section-number">7.6</span> Update the dose regimen</a></li>
  <li><a href="#example-3" id="toc-example-3" class="nav-link" data-scroll-target="#example-3"><span class="header-section-number">7.7</span> Example</a></li>
  </ul></li>
  <li><a href="#dynamic-change-in-dosing-interval" id="toc-dynamic-change-in-dosing-interval" class="nav-link" data-scroll-target="#dynamic-change-in-dosing-interval"><span class="header-section-number">8</span> Dynamic change in dosing interval</a>
  <ul class="collapse">
  <li><a href="#force-the-model-to-stop-at-dose-times" id="toc-force-the-model-to-stop-at-dose-times" class="nav-link" data-scroll-target="#force-the-model-to-stop-at-dose-times"><span class="header-section-number">8.1</span> Force the model to stop at dose times</a></li>
  </ul></li>
  <li><a href="#remember-there-usually-is-no-data-set" id="toc-remember-there-usually-is-no-data-set" class="nav-link" data-scroll-target="#remember-there-usually-is-no-data-set"><span class="header-section-number">9</span> Remember: there (usually) is no data set</a></li>
  <li><a href="#more-to-come" id="toc-more-to-come" class="nav-link" data-scroll-target="#more-to-come"><span class="header-section-number">10</span> More to come</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>The <code>evtools</code> plugin is a set of functions and classes you can use to implement dosing regimens from <em>inside</em> your model. It first became available in mrgsolve 1.4.1.</p>
<p>The most common use for this plugin is when you want to implement dynamic dosing simulations where the dose amount or the dosing interval is able to change based on how the system has advanced up to a certain point. For example, you might have a PKPD model for an oncology drug that includes a PK model for the drug as well as a dynamic model for platelets where a decline in platelets is driven by the drug concentration. In this case you might monitor platelets at different clinical visits and reduce the or hold dose or increase the dosing interval in response to Grade 3 or Grade 4 thrombocytopenia.</p>
<p>In this blog post, I’ll introduce the new functionality provided by <code>evtools</code>. This is a rather long and detailed post because I’m going to be using it to prototype demo / documentation for these new features. I want to take the time to touch on different aspects of <code>evtools</code> in some detail for clarity, so it might take some time to work through the content. But each feature has a complete working example to show you a working model and the associated simulation output. So keep reading and see how these features might be helpful to you in your dynamic dosing simulation work.</p>
</section>
<section id="setup" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="setup"><span class="header-section-number">2</span> Setup</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mrgsolve)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="invoking-evtools" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="invoking-evtools"><span class="header-section-number">3</span> Invoking <code>evtools</code></h2>
<p>Like any plugin, you need to opt in to using the functionality provided by <code>evtools</code>. Do this with the <code>$PLUGIN</code> block</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PLUGIN evtools</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Plugins bring in additional functionality or syntax beyond what you get with the basic mrgsolve model code. They either make your model more convenient (to code) or more powerful.</p>
</section>
<section id="everything-is-in-the-evt-namespace" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="everything-is-in-the-evt-namespace"><span class="header-section-number">4</span> Everything is in the <code>evt</code> namespace</h2>
<p>All of the functionality provided by <code>evtools</code> is within a namespace called <code>evt</code>. To access functions, typedefs or classes in <code>evt</code>, please point to the namespace by prefixing with <code>evt::</code>.</p>
<p>For example, there a function called <code>bolus()</code> which is located in the <code>evt</code> namespace. So we have to call that function with <code>evt::bolus()</code> rather than plain old <code>bolus()</code>. This prefixing is roughly equivalent to calling <code>dplyr::mutate()</code> or <code>purrr::map()</code> which is currently a popular R coding style.</p>
<p>Another example is a typedef called <code>evt::ev</code> for the C++ event objects we use in the model. That <code>evt::bolus()</code> function an be called in a way that <em>returns</em> an event object. You can use the typedef in <code>evt</code> like this</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>ev dose <span class="ot">=</span> evt<span class="sc">::</span><span class="fu">bolus</span>(<span class="dv">100</span>, <span class="dv">1</span>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Then work with the <code>dose</code> object as you wish (keep reading for more discussion about how this works).</p>
</section>
<section id="functions-to-administer-single-doses-now" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="functions-to-administer-single-doses-now"><span class="header-section-number">5</span> Functions to administer single doses now</h2>
<p>Users have been able to give doses from inside their mrgsolve model for a while now. With the <code>evtools</code> plugin, this should be much easier to do, with a simple, easy to remember syntax.</p>
<p>To trigger a single <strong>bolus</strong> dose of 100 units into the first compartment, call</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span><span class="fu">bolus</span>(self, <span class="dv">100</span>, <span class="dv">1</span>); </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The arguments here are</p>
<ul>
<li><code>self</code> (<code>databox</code>) - an object used by mrgsolve to communicate with the model code</li>
<li><code>amt</code> (<code>double</code>) - the dose amount</li>
<li><code>cmt</code> (<code>int</code>) - the dose compartment number</li>
</ul>
<p>Notice there is no return value to this function; this one call specifies the dose and sends it back to mrgsolve via <code>self</code> to implement.</p>
<p>To trigger a single <strong>infusion</strong> of 100 units into the first compartment with rate of 5 units / time, call</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span><span class="fu">infuse</span>(self, <span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">5</span>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The signature for <code>evt::infuse()</code> is similar to <code>evt::bolus()</code>, but just add a <code>rate</code> argument at the end of the signature.</p>
<ul>
<li><code>self</code> (<code>databox</code>) - an object used by mrgsolve to communicate with the model code</li>
<li><code>amt</code> (<code>double</code>) - the dose amount</li>
<li><code>cmt</code> (<code>int</code>) - the dose compartment number</li>
<li><code>rate</code> (<code>double</code>) - the infusion rate</li>
</ul>
<p>You should call <code>evt::bolus()</code> and <code>evt::infuse()</code> from <code>$ERROR</code>. You will also need to figure out <em>when</em> the dose should be triggered. Writing the following code will give you a dose <em>every time</em> <code>$ERROR</code> is called</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span><span class="fu">infuse</span>(self, <span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">5</span>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This is probably not what you want. There are multiple ways you can handle this. The simplest way is to check <code>TIME</code> <em>and</em> <code>EVID</code></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(TIME<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> EVID<span class="sc">==</span><span class="dv">0</span>) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  evt<span class="sc">::</span><span class="fu">infuse</span>(self, <span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">5</span>);</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This will get you a dose when <code>TIME==0</code> and <code>EVID==0</code>. I highly recommend checking something other than just <code>TIME</code> when deciding to dose since there may be other “events” that are taking place at the time you want to check for giving a dose. You can easily fire off two doses at the dose time rather than just the intended one dose.</p>
<section id="example" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="example"><span class="header-section-number">5.1</span> Example</h3>
<p>Model <code>evtools-1.mod</code> will implement a dose via <code>evt::infuse()</code>.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>See the full model 1 code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>evtools-1.mod</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM CL <span class="ot">=</span> <span class="dv">1</span>, V <span class="ot">=</span> <span class="dv">10</span>, KA <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PKMODEL cmt <span class="ot">=</span> <span class="st">"GUT,CENT"</span>, depot <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>SET outvars <span class="ot">=</span> <span class="st">"CP"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PLUGIN evtools</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(TIME<span class="sc">==</span><span class="dv">0</span>) evt<span class="sc">::</span><span class="fu">infuse</span>(self, <span class="dv">100</span>, <span class="dv">2</span>, <span class="fl">100.0</span><span class="sc">/</span><span class="fl">20.0</span>);</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>capture CP <span class="ot">=</span> CENT<span class="sc">/</span>V;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread</span>(<span class="st">"evtools-1.mod"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building evtools-1_mod ... done.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim</span>(mod, <span class="at">end =</span> <span class="dv">72</span>, <span class="at">delta =</span> <span class="fl">0.2</span>) </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-new-1-4-0-evtools_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="functions-to-administer-single-customized-doses" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="functions-to-administer-single-customized-doses"><span class="header-section-number">6</span> Functions to administer single, customized doses</h2>
<p>A similar set of functions will implement bolus or infusion doses, but allowing you to interact with the event object prior to sending it back to mrgsolve.</p>
<p>To create an object for a 100 unit <strong>bolus</strong> dose into compartment 1, call</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>ev dose <span class="ot">=</span> evt<span class="sc">::</span><span class="fu">bolus</span>(<span class="dv">100</span>, <span class="dv">1</span>); </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The arguments here are dose <code>amt</code> and the dosing <code>compartment</code> number. Notice that we don’t pass in <code>self</code>, but rather we get the object back (as <code>dose</code>) for us to work with.</p>
<p>To create an object for a 100 unit <strong>infusion</strong> into compartment 1 with rate of 5 units / time, call</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>ev dose <span class="ot">=</span> evt<span class="sc">::</span><span class="fu">infuse</span>(<span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">5</span>); </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Again, the arguments are: <code>amt</code>, <code>cmt</code>, <code>rate</code> and we get an object back with which we can work.</p>
<section id="functions-to-work-on-event-objects" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="functions-to-work-on-event-objects"><span class="header-section-number">6.1</span> Functions to work on event objects</h3>
<p>You can use the following functions to work on the event objects returned by <code>evt::bolus()</code> and <code>evt::infuse()</code></p>
<ul>
<li><code>evt::retime(&lt;event object&gt;, &lt;time&gt;)</code> - set the <code>time</code> attribute; this also sets the <code>now</code> attribute to <code>false</code> so the dose will get scheduled in the future if <code>&lt;time&gt;</code> is greater than the current <code>TIME</code><br>
</li>
<li><code>evt::now(&lt;event object&gt;)</code> - make the event happen <code>now</code>; when mrgsolve processes this event object, the <code>time</code> attribute will be ignored</li>
</ul>
</section>
<section id="be-sure-to-send-the-object-back-to-mrgsolve" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="be-sure-to-send-the-object-back-to-mrgsolve"><span class="header-section-number">6.2</span> Be sure to send the object back to mrgsolve</h3>
<p>When you create an event object through</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>ev dose <span class="ot">=</span> evt<span class="sc">::</span><span class="fu">infuse</span>(<span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">5</span>); </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>you have to be sure to “send” the event object (<code>dose</code>) object created by the call back to mrgsolve for processing.</p>
<p>New in mrgsolve 1.4.1 is a <code>push()</code> method in the <code>self</code> object that lets you “push” the event back for processing. For the dose object, it would look like</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">self.push</span>(dose);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The previous syntax for pushing event objects back was pretty technical and difficult to remember. That old syntax is still valid, but we recommend calling <code>push()</code> as shown above.</p>
</section>
<section id="example-1" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="example-1"><span class="header-section-number">6.3</span> Example</h3>
<p>Model <code>evtools-2.mod</code> shows an example of creating an event object, retiming the dose and sending it back to mrgsolve. We’ll start an infusion of 100 mg over 28 hours and have it start 12 hours into the simulation.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>See the full model 2 code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>evtools-2.mod</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM CL <span class="ot">=</span> <span class="dv">1</span>, V <span class="ot">=</span> <span class="dv">10</span>, KA <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PKMODEL cmt <span class="ot">=</span> <span class="st">"GUT,CENT"</span>, depot <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PLUGIN evtools</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>SET outvars <span class="ot">=</span> <span class="st">"CP"</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(TIME<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> EVID<span class="sc">==</span><span class="dv">0</span>) {</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  evt<span class="sc">::</span>ev dose <span class="ot">=</span> evt<span class="sc">::</span><span class="fu">infuse</span>(<span class="dv">100</span>, <span class="dv">2</span>, <span class="fl">100.0</span><span class="sc">/</span><span class="fl">28.0</span>);</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  evt<span class="sc">::</span><span class="fu">retime</span>(dose, <span class="dv">12</span>);</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">self.push</span>(dose);</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>capture CP <span class="ot">=</span> CENT<span class="sc">/</span>V;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread</span>(<span class="st">"evtools-2.mod"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building evtools-2_mod ... done.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim</span>(mod, <span class="at">end =</span> <span class="dv">72</span>, <span class="at">delta =</span> <span class="fl">0.2</span>) </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-new-1-4-0-evtools_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="an-object-to-implement-a-full-dosing-regimen" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="an-object-to-implement-a-full-dosing-regimen"><span class="header-section-number">7</span> An object to implement a full dosing regimen</h2>
<p>In the previous sections, we’ve looked ways you can trigger a single dose from within your model file. You could trigger a sequence of doses (e.g., once-daily dosing) by using these functions with a little bit of bookkeeping. But it would be convenient to just tell mrgsolve that you want</p>
<ul>
<li>a certain dose</li>
<li>given at a certain interval</li>
<li>for a certain duration</li>
</ul>
<p>This is what the <code>evt::regimen</code> class will do for you via the <code>evtools</code> namespace. In addition to just starting the regimen, you can <em>change</em> the regimen (dose amount, dose interval, anything) at any point in the simulation.</p>
<p>This requires a little more coding that the convenience functions we discussed earlier. In the following sections, we will talk you through each part in order and then show a complete example.</p>
<section id="setting-up-a-regimen-object" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="setting-up-a-regimen-object"><span class="header-section-number">7.1</span> Setting up a <code>regimen</code> object</h3>
<p>To create the regimen object, you have to declare this in the <code>$GLOBAL</code> block</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>GLOBAL</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>regimen reg;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>When you create the object in <code>$GLOBAL</code>, you are allowing any other block to interact with or modify that object.</p>
</section>
<section id="initializing-the-regimen-object" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="initializing-the-regimen-object"><span class="header-section-number">7.2</span> Initializing the <code>regimen</code> object</h3>
<p>We initialize by passing in the <code>self</code> object to the <code>init()</code> method. This makes sure the <code>regimen</code> can communicate with mrgsolve (via <code>self</code>). You only need to do this once, so you can write this in either <code>$PREAMBLE</code></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PREAMBLE</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">reg.init</span>(self);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>or in <code>$PK</code> (it’s ok to do this multiple times)</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PK </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(NEWIND <span class="sc">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.init</span>(self);</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="setting-up-the-regimen-object" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="setting-up-the-regimen-object"><span class="header-section-number">7.3</span> Setting up the <code>regimen</code> object</h3>
<p>For every subject, we want to set (or reset) this object to the starting dose, interval, etc. There are a series of “setter” functions that allow you to set each of these attributes For a 100 mg infusion into the first compartment over 1.5 hours every 24 hours for a week, it would look like</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PK</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(NEWIND <span class="sc">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.init</span>(self); </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(<span class="dv">100</span>); </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.cmt</span>(<span class="dv">1</span>);</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.rate</span>(<span class="fu">reg.amt</span>()<span class="sc">/</span><span class="fl">1.5</span>);</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(<span class="dv">24</span>);</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.until</span>(<span class="dv">168</span>);</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Note that you will probably want to avoid hard-coding these numbers in to your model. It will work better if you pass them as parameters, so they can be adjusted from simulation to simulation.</p>
<p>Also note that I’ve put this in <code>$PK</code> because we are setting up the object at the start of each new individual in the problem.</p>
</section>
<section id="execute-the-regimen" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="execute-the-regimen"><span class="header-section-number">7.4</span> Execute the regimen</h3>
<p>Once you have everything set up, call <code>execute()</code> to actually start giving the doses; this should be done in <code>$ERROR</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">reg.execute</span>();</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>That’s it! Your dosing regimen is now active.</p>
</section>
<section id="example-2" class="level3" data-number="7.5">
<h3 data-number="7.5" class="anchored" data-anchor-id="example-2"><span class="header-section-number">7.5</span> Example</h3>
<p>Model <code>evtools-3.mod</code> gives a very simple example of setting up a dosing regimen using <code>evt::regmen</code>.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>See the full model 3 code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>evtools-3.mod</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM CL <span class="ot">=</span> <span class="dv">1</span>, V <span class="ot">=</span> <span class="dv">10</span>, KA <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>DOSE <span class="ot">=</span> <span class="dv">100</span>, INTERVAL <span class="ot">=</span> <span class="dv">24</span>, DUR <span class="ot">=</span> <span class="fl">0.5</span>, UNTIL <span class="ot">=</span> <span class="dv">168</span>, WHERE <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PKMODEL cmt <span class="ot">=</span> <span class="st">"GUT,CENT"</span>, depot <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>SET outvars <span class="ot">=</span> <span class="st">"CP"</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PLUGIN evtools</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>GLOBAL</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>regimen reg;</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PK</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(NEWIND <span class="sc">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.init</span>(self);</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(DOSE);</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(INTERVAL);</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.rate</span>(DOSE<span class="sc">/</span>DUR);</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.until</span>(UNTIL);</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.cmt</span>(WHERE);</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="fu">reg.execute</span>();</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>capture CP <span class="ot">=</span> CENT<span class="sc">/</span>V;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread</span>(<span class="st">"evtools-3.mod"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building evtools-3_mod ... done.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim</span>(mod, <span class="at">end =</span> <span class="dv">200</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-new-1-4-0-evtools_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that we didn’t use a data set for this simulation; all of the doses in the regimen come from the <code>reg</code> object we set up.</p>
</section>
<section id="update-the-dose-regimen" class="level3" data-number="7.6">
<h3 data-number="7.6" class="anchored" data-anchor-id="update-the-dose-regimen"><span class="header-section-number">7.6</span> Update the dose regimen</h3>
<p>What if we want to make changes to the regimen? Say we have a PKPD model and want to lower the dose whenever the PD marker gets too low or too high?</p>
<p>This is handled naturally within the <code>evt::regimen</code> framework by calling the same setter functions you used to set / reset the <code>regimen</code> object at the start of the problem as shown in the next example.</p>
</section>
<section id="example-3" class="level3" data-number="7.7">
<h3 data-number="7.7" class="anchored" data-anchor-id="example-3"><span class="header-section-number">7.7</span> Example</h3>
<p>Model <code>evtools-4.mod</code> gives an example of dynamically changing the dose using <code>evt::regmen</code>.</p>
<p>In this example, we have a indirect response PKPD model where concentration inhibits the production of the response. The EC50 is 7 ng / mL but with substantial between subject variability.</p>
<p>Every subject starts on 200 mg once daily. Once a week, we’ll reduce the dose by 25% if the PD response is smaller than 3,000. This isn’t terribly sophisticated decision rule but we’ll stick with it for simplicity.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>See the full model 4 code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>evtools-4.mod</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM CL <span class="ot">=</span> <span class="dv">1</span>, V <span class="ot">=</span> <span class="dv">10</span>, KA <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM KIN <span class="ot">=</span> <span class="dv">100</span>, KOUT <span class="ot">=</span> <span class="fl">0.02</span>, EC50 <span class="ot">=</span> <span class="dv">7</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>DOSE <span class="ot">=</span> <span class="dv">100</span>, INTERVAL <span class="ot">=</span> <span class="dv">24</span>, DUR <span class="ot">=</span> <span class="fl">0.5</span>, UNTIL <span class="ot">=</span> <span class="dv">168</span>, WHERE <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>OMEGA <span class="fl">0.5</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>CMT GUT CENT PD</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PLUGIN evtools</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>GLOBAL</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>regimen reg;</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PK</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(NEWIND <span class="sc">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.init</span>(self);</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(DOSE);</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(INTERVAL);</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.rate</span>(DOSE<span class="sc">/</span>DUR);</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.until</span>(UNTIL);</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.cmt</span>(WHERE);</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>PD_0 <span class="ot">=</span> KIN <span class="sc">/</span> KOUT;</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>double ec50 <span class="ot">=</span> <span class="fu">exp</span>(<span class="fu">log</span>(EC50) <span class="sc">+</span> <span class="fu">ETA</span>(<span class="dv">1</span>));</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ODE</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>dxdt_GUT <span class="ot">=</span> <span class="sc">-</span>KA <span class="sc">*</span> GUT;</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>dxdt_CENT <span class="ot">=</span> KA <span class="sc">*</span> GUT <span class="sc">-</span> (CL<span class="sc">/</span>V) <span class="sc">*</span> CENT;</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>double cp <span class="ot">=</span> CENT<span class="sc">/</span>V;</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>double inh <span class="ot">=</span> cp<span class="sc">/</span>(ec50 <span class="sc">+</span> cp);</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>dxdt_PD <span class="ot">=</span> KIN <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>inh) <span class="sc">-</span> KOUT <span class="sc">*</span> PD;</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>capture PK <span class="ot">=</span> CENT<span class="sc">/</span>V;</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">fmod</span>(TIME, <span class="dv">168</span>)<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> PD <span class="sc">&lt;</span> <span class="dv">3000</span>) {</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(<span class="fu">reg.amt</span>() <span class="sc">*</span> <span class="fl">0.75</span>);</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.rate</span>(<span class="fu">reg.amt</span>() <span class="sc">/</span> DUR);</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>capture dose <span class="ot">=</span> <span class="fu">reg.amt</span>();</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a><span class="fu">reg.execute</span>();</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>CAPTURE ec50</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</div>
<p>We’ll simulate 12 random subjects</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>idata <span class="ot">&lt;-</span> <span class="fu">expand.idata</span>(<span class="at">ID =</span> <span class="fu">seq</span>(<span class="dv">12</span>), <span class="at">DOSE =</span> <span class="dv">200</span>, <span class="at">UNTIL =</span> <span class="dv">2400</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread</span>(<span class="st">"evtools-4.mod"</span>, <span class="at">outvars =</span> <span class="st">"PK,PD,dose,ec50"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building evtools-4_mod ... done.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  mod, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">idata =</span> idata, </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">end =</span> <span class="dv">8</span><span class="sc">*</span><span class="dv">168</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Look at PK, PD, and dose versus time; I’ll facet the plots by the simulated EC50, from lowest to highest.</p>
<p>First, concentration versus time</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(out, <span class="fu">aes</span>(time, PK, <span class="at">col =</span> ec50)) <span class="sc">+</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>ec50)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-new-1-4-0-evtools_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next, pharmacodynamics versus time; remember, we’re trying to keep the predose response above 3,000</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(out, <span class="fu">aes</span>(time, PD, <span class="at">col =</span> ec50)) <span class="sc">+</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">3000</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>ec50)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-new-1-4-0-evtools_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, the current dose versus time</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(out, <span class="fu">aes</span>(time, dose, <span class="at">col =</span> ec50)) <span class="sc">+</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>ec50) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-new-1-4-0-evtools_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can look at how doses, PK and PD fared at the end of the simulation. Only a handful of subjects stayed at the starting dose; most got dose reduced with some ending on doses far below the 200 mg starting dose.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>out <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="fu">n</span>()) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(ec50)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 6
      ID  time    PD ec50     PK  dose
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt;
 1     9  1344 3078. 1.38  0.273  26.7
 2     7  1344 3261. 1.65  0.273  26.7
 3    11  1344 3256. 2.16  0.364  35.6
 4    12  1344 3113. 2.51  0.486  47.5
 5     6  1344 3261. 2.9   0.486  47.5
 6    10  1344 3298. 4     0.647  63.3
 7     5  1344 3161. 6.24  1.15  112. 
 8     8  1344 3059. 7.55  1.53  150  
 9     3  1344 3201. 8.64  1.53  150  
10     1  1344 3258. 9.13  1.53  150  
11     4  1344 3002. 9.55  2.05  200  
12     2  1344 3152. 11    2.05  200  </code></pre>
</div>
</div>
</section>
</section>
<section id="dynamic-change-in-dosing-interval" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="dynamic-change-in-dosing-interval"><span class="header-section-number">8</span> Dynamic change in dosing interval</h2>
<p>Model <code>evtools-5.mod</code> gives an example of dynamically changing the dose interval using <code>evt::regmen</code>. When we’ve done dynamic dosing in the past, it was always pretty easy to change the <em>dose</em> during the simulation, maybe through the bioavailability parameter. But changing the interval seemed impossible … until now.</p>
<p>To start, doses will be administered every 24 hours. Then, the dosing interval will be cut in half (every 12 hours) while doubling the dose amount; this will happen after the first week of dosing.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(evt<span class="sc">::</span><span class="fu">near</span>(TIME, <span class="fl">168.0</span>) <span class="sc">&amp;&amp;</span> EVID <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(<span class="dv">12</span>);</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(DOSE<span class="sc">/</span><span class="fl">2.0</span>);</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Notice I’m using <code>evt::near()</code> here to compare two floating point numbers. This works similar to <code>dplyr::near()</code>, including default tolerance of 1e-8.</p>
<p>Also, I’m checking that <code>EVID &gt; 0</code>; the reason for this is that we are using <code>reg.flagnext()</code> in this model (see below).</p>
<p>At 300 hours, we’ll bring the dose back to double the starting value and change the dosing interval to every 48 hours</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(evt<span class="sc">::</span><span class="fu">near</span>(TIME, <span class="dv">168</span>) <span class="sc">&amp;&amp;</span> EVID <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(<span class="fu">reg.ii</span>()<span class="sc">/</span><span class="fl">2.0</span>);</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(<span class="fu">reg.amt</span>()<span class="sc">/</span><span class="fl">2.0</span>);</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(evt<span class="sc">::</span><span class="fu">near</span>(TIME, <span class="dv">300</span>) <span class="sc">&amp;&amp;</span> EVID <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(<span class="fu">reg.ii</span>()<span class="sc">*</span><span class="dv">4</span>);</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(<span class="fu">reg.amt</span>()<span class="sc">*</span><span class="dv">4</span>);</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>See the full model 5 code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>evtools-5.mod</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM CL <span class="ot">=</span> <span class="dv">1</span>, V <span class="ot">=</span> <span class="dv">10</span>, KA <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PARAM</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>DOSE <span class="ot">=</span> <span class="dv">100</span>, INTERVAL <span class="ot">=</span> <span class="dv">24</span>, DUR <span class="ot">=</span> <span class="fl">0.5</span>, UNTIL <span class="ot">=</span> <span class="dv">540</span>, WHERE <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PKMODEL cmt <span class="ot">=</span> <span class="st">"GUT,CENT"</span>, depot <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>SET outvars <span class="ot">=</span> <span class="st">"CP"</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PLUGIN evtools</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>GLOBAL</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>evt<span class="sc">::</span>regimen reg;</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PK</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(NEWIND <span class="sc">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.init</span>(self);</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(DOSE);</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(INTERVAL);</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.cmt</span>(WHERE);</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.until</span>(UNTIL);</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.flagnext</span>();</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(evt<span class="sc">::</span><span class="fu">near</span>(TIME, <span class="dv">168</span>) <span class="sc">&amp;&amp;</span> EVID <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(<span class="fu">reg.ii</span>() <span class="sc">/</span> <span class="fl">2.0</span>);</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(<span class="fu">reg.amt</span>() <span class="sc">/</span> <span class="fl">2.0</span>);</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(evt<span class="sc">::</span><span class="fu">near</span>(TIME, <span class="dv">300</span>) <span class="sc">&amp;&amp;</span> EVID <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.ii</span>(<span class="fu">reg.ii</span>() <span class="sc">*</span> <span class="dv">4</span>);</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reg.amt</span>(<span class="fu">reg.amt</span>() <span class="sc">*</span> <span class="dv">4</span>);</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="fu">reg.execute</span>();</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>capture CP <span class="ot">=</span> CENT<span class="sc">/</span>V;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread</span>(<span class="st">"evtools-5.mod"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building evtools-5_mod ... done.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mrgsim</span>(mod, <span class="at">end =</span> <span class="dv">600</span>, <span class="at">delta =</span> <span class="fl">0.1</span>) <span class="sc">%&gt;%</span> <span class="fu">plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-new-1-4-0-evtools_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="force-the-model-to-stop-at-dose-times" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="force-the-model-to-stop-at-dose-times"><span class="header-section-number">8.1</span> Force the model to stop at dose times</h3>
<p>This model uses the <code>object.flagnext()</code> setter. When we “flag” the next dose, we tell mrgsolve to <em>always</em> stop the simulation when we expect the next dose to be given. This is a hard stop with a reset / reinitialization of the ODE solver.</p>
<p>This isn’t strictly necessary in this simulation because we already have observation records at all of the times when doses might be due (delta is set to 0.1 here). But you can use <code>object.flagnext()</code> in case you don’t want to sample that intensively or in case you can’t be <em>sure</em> the ODE solver will otherwise stop at the time when you might way to give a dose. To be clear: you must make sure the system “hits” all of the dose times. Usually this is done at observation times. If it can’t be guaranteed at observation times, then you need to tell the problem to flag the next dose times via <code>object.flagnext()</code>.</p>
</section>
</section>
<section id="remember-there-usually-is-no-data-set" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="remember-there-usually-is-no-data-set"><span class="header-section-number">9</span> Remember: there (usually) is no data set</h2>
<p>As a general consideration for most or all of the functionality in <code>evtools</code>, it’s important to remember that you don’t need a data set for these simulations. Normally you do need one for doses, at least. This gives a signal to mrgsolve when to stop and actually give the doses and this is done <em>before</em> the simulation starts. With dynamic dosing within the model itself, it’s different: we are making dosing decisions from minute to minute, giving a dose when it is due.</p>
<p>This means there is more pressure on <em>you</em> to make sure you are requesting observations at times when you might need to give a dose. If you don’t do that, there is no reason why mrgsolve will stop to give a dose when you think it should. There is some functionality baked into these tools to help that, but you need to be aware of the model time and when the model might be stopping to let you make an intervention. This isn’t always very difficult to do, but it could be a little surprising if you forget to consider this issue.</p>
<p>Along the same lines, be very careful when requesting that model stops to give a dose based on <code>TIME</code> alone. For example I might want the model to stop at 24 hours to give a dose</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(TIME<span class="sc">==</span><span class="dv">24</span>) <span class="sc">&lt;</span>give a dose<span class="sc">&gt;</span>;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This seems like a very reasonable thing to do. But do you know that the model will only stop once at <code>TIME==24</code>? could there be multiple stops at <code>TIME==24</code> that would give you multiple doses in this case?</p>
<p>I’d recommend refactoring this check to include <code>EVID</code> as well</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(TIME<span class="sc">==</span><span class="dv">24</span> <span class="sc">&amp;&amp;</span> EVID<span class="sc">==</span><span class="dv">0</span>) <span class="sc">&lt;</span>give a dose<span class="sc">&gt;</span>;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Here, assuming we have a single time vector for each individual, you can know that the model stops only once for an observation at 24 hours and you won’t get a second dose for another, non-EVID==0 record.</p>
<p>Also, what if we wanted this to happen</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(TIME<span class="sc">==</span><span class="fl">14.2</span> <span class="sc">&amp;&amp;</span> EVID<span class="sc">==</span><span class="dv">0</span>) <span class="sc">&lt;</span>give a dose<span class="sc">&gt;</span>;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>But passed in a time vector of</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</code></pre>
</div>
</div>
<p>In this case, the model <em>will not stop</em> at 14.2 hours because we only have whole number observation times.</p>
<p>Again, most of the time it’s not difficult to easily get around these issues; but please do be cautious when planning your simulation inputs.</p>
<p>If you do run into trouble here, it can be helpful to pass in a data set with more carefully thought out observations. Or, write some R code to create a data set with milestones coded with different non-zero event IDs that you can check in your model code to see if something needs to happen. This seems like a lot of work up front, but it can actually save you time fixing issues down the road.</p>
</section>
<section id="more-to-come" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="more-to-come"><span class="header-section-number">10</span> More to come</h2>
<p>This is just the start - basic functionality to get in the game, see how it works, etc. I know of several additional features / nuance that will eventually be needed to handle inevitable complexity in many dose adjustment schemes. This will come, along with features that we don’t even know about yet.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>