<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.299">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kyle Baron">
<meta name="dcterms.date" content="2022-05-25">
<meta name="description" content="If your mrgsolve model is a translation of a completed model run, you can validate it every time; find out how.">

<title>mrgsolve/blog - Validate model translation from NONMEM</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-banner {
      color: white;
background: #097f5f;
    }
    </style>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">mrgsolve/blog</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/user_guide">UserGuide</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/blog">Blog</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/vignettes">Vignettes</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/learn.html">Learn</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org/docs">Docs</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/mrgsolve/depot">Models</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-source" role="button" data-bs-toggle="dropdown" aria-expanded="false">Source</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-source">    
        <li>
    <a class="dropdown-item" href="https://github.com/metrumresearchgroup/mrgsolve">
 <span class="dropdown-text">GitHub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://cran.r-project.org/package=mrgsolve">
 <span class="dropdown-text">CRAN</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false">Help</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/metrumresearchgroup/mrgsolve/discussions">
 <span class="dropdown-text">Discuss</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/metrumresearchgroup/mrgsolve/issues">
 <span class="dropdown-text">Report an issue</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://mrgsolve.org">mrgsolve.org</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/metrumresearchgroup/mrgsolve"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mrgsolve"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Validate model translation from NONMEM</h1>
                          <div class="quarto-categories">
                <div class="quarto-category">model specification</div>
                <div class="quarto-category">validation</div>
              </div>
                  </div>
  </div>
    
  <div>
    <div class="description">
      <p>If your mrgsolve model is a translation of a completed model run, you can validate it every time; find out how.</p>
    </div>
  </div>




  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Kyle Baron </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">05/25/2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"> <span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"> <span class="header-section-number">2</span> Data</a>
  <ul class="collapse">
  <li><a href="#bbrnm_join" id="toc-bbrnm_join" class="nav-link" data-scroll-target="#bbrnm_join"> <span class="header-section-number">2.1</span> bbr::nm_join</a></li>
  </ul></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model"> <span class="header-section-number">3</span> Model</a></li>
  <li><a href="#simulate" id="toc-simulate" class="nav-link" data-scroll-target="#simulate"> <span class="header-section-number">4</span> Simulate</a></li>
  <li><a href="#compare" id="toc-compare" class="nav-link" data-scroll-target="#compare"> <span class="header-section-number">5</span> Compare</a></li>
  <li><a href="#complete-workflow" id="toc-complete-workflow" class="nav-link" data-scroll-target="#complete-workflow"> <span class="header-section-number">6</span> Complete workflow</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion"> <span class="header-section-number">7</span> Discussion</a></li>
  <li><a href="#sec-appendix" id="toc-sec-appendix" class="nav-link" data-scroll-target="#sec-appendix"> <span class="header-section-number">8</span> Appendix</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>We frequently use mrgsolve to simulate from models estimated in NONMEM. This requires <em>translation</em> of the model from the NONMEM control stream into mrgsolve format.</p>
<p>There is a straightforward way to confirm correct coding of the mrgsolve model once the NONMEM model is in hand. This blog post will show you how to do that.</p>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target="#callout-1" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Expand view packages and options
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(mrgsolve)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(here)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">options</span>(<span class="at">bbr.verbose =</span> <span class="cn">FALSE</span>, <span class="at">mrgsolve.project =</span> <span class="fu">here</span>(<span class="st">"model/pk"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="data" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data</h1>
<p>The validation of the mrgsolve model coding is driven by <code>PRED</code> which was tabled when the NONMEM run finished. This is the standard against which we will evaluate the mrgsolve model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">here</span>(<span class="st">"model/pk/106/106.tab"</span>))</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">head</span>(tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   NUM    IPRED        NPDE       CWRES      DV     PRED        RES       WRES
1:   1  0.00000  0.00000000  0.00000000   0.000  0.00000  0.0000000  0.0000000
2:   2 68.53183 -0.53401190 -0.51213920  61.005 60.58323  0.4217692 -0.5334058
3:   3 90.81217  0.27931900  0.12607810  90.976 78.54761 12.4283900  0.1424843
4:   4 97.27639  1.55477400  1.44380800 122.210 83.03988 39.1701200  1.6307490
5:   5 96.73790  1.88079400  1.69356600 126.090 82.22198 43.8680200  1.9132660
6:   6 88.70574  0.06689328 -0.05272759  84.682 75.48693  9.1950690 -0.0940618</code></pre>
</div>
</div>
<p>We want to make sure we have the <em>same input data</em> for the validation that we had for the model estimation. So we will read in the analysis data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>nmdata <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">here</span>(<span class="st">"data/derived/analysis3.csv"</span>), <span class="at">na.strings =</span> <span class="st">'.'</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a>nmdata <span class="ot">&lt;-</span> <span class="fu">select</span>(nmdata, <span class="sc">-</span>DV)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and then merge it on by a row counter called <code>NUM</code> which uniquely connects output rows to input rows</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(tab, nmdata, <span class="at">by =</span> <span class="st">"NUM"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that in the join, <code>tab</code> is on the left so that the resulting <code>data</code> drops the records from <code>nmdata</code> that didn’t make it into the analysis.</p>
<p>Now, we have the analysis data set with <code>PRED</code> (from NONMEM) as a column</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">select</span>(data, ID, NUM, TIME, EVID, AMT, CMT, DV, PRED)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       ID  NUM   TIME EVID AMT CMT      DV     PRED
   1:   1    1   0.00    1   5   1   0.000  0.00000
   2:   1    2   0.61    0  NA   2  61.005 60.58323
   3:   1    3   1.15    0  NA   2  90.976 78.54761
   4:   1    4   1.73    0  NA   2 122.210 83.03988
   5:   1    5   2.15    0  NA   2 126.090 82.22198
  ---                                              
4288: 160 4356  60.09    0  NA   2  99.059 39.55937
4289: 160 4357  72.03    0  NA   2  64.482 33.24345
4290: 160 4358  84.18    0  NA   2  77.621 27.89484
4291: 160 4359  96.02    0  NA   2  33.907 23.52130
4292: 160 4360 120.09    0  NA   2  36.249 16.63423</code></pre>
</div>
</div>
<section id="bbrnm_join" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="bbrnm_join"><span class="header-section-number">2.1</span> bbr::nm_join</h2>
<div class="callout-note callout callout-style-simple">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>If you are using <a href="https://github.com/metrumresearchgroup/bbr">bbr</a> as your modeling platform, you can get the same data set with a one-liner call to <code>bbr::nm_join()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>data <span class="ot">&lt;-</span> <span class="fu">nm_join</span>(<span class="fu">here</span>(<span class="st">"model/pk/106"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="model" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Model</h1>
<p>The model is a standard two-compartment PK model from run <code>106</code>; we’ve already coded the model here</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread_cache</span>(<span class="st">"106.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target="#callout-2" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Expand to see the model code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1"></a><span class="op">[</span> prob <span class="op">]</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="dv">106</span><span class="op">-</span><span class="dv">104</span> <span class="op">+</span> COV<span class="op">-</span>effects<span class="op">(</span>CRCL<span class="op">,</span> AGE<span class="op">)</span> on CL</span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="op">[</span> pkmodel <span class="op">]</span> cmt <span class="op">=</span> <span class="st">"GUT,CENT,PERIPH"</span><span class="op">,</span> depot <span class="op">=</span> TRUE</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="op">[</span> param <span class="op">]</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>WT   <span class="op">=</span> <span class="dv">70</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>EGFR <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>ALB  <span class="op">=</span> <span class="fl">4.5</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>AGE  <span class="op">=</span> <span class="dv">35</span></span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="op">[</span> nmxml <span class="op">]</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>path <span class="op">=</span> <span class="st">"106/106.xml"</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>root <span class="op">=</span> <span class="st">"cppfile"</span></span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="op">[</span> main <span class="op">]</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="dt">double</span> V2WT   <span class="op">=</span> log<span class="op">(</span>WT<span class="op">/</span><span class="fl">70.0</span><span class="op">);</span></span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="dt">double</span> CLWT   <span class="op">=</span> log<span class="op">(</span>WT<span class="op">/</span><span class="fl">70.0</span><span class="op">)*</span><span class="fl">0.75</span><span class="op">;</span></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="dt">double</span> CLEGFR <span class="op">=</span> log<span class="op">(</span>EGFR<span class="op">/</span><span class="fl">90.0</span><span class="op">)*</span>THETA6<span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20"></a><span class="dt">double</span> CLAGE  <span class="op">=</span> log<span class="op">(</span>AGE<span class="op">/</span><span class="fl">35.0</span><span class="op">)*</span>THETA7<span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21"></a><span class="dt">double</span> V3WT   <span class="op">=</span> log<span class="op">(</span>WT<span class="op">/</span><span class="fl">70.0</span><span class="op">);</span></span>
<span id="cb10-22"><a href="#cb10-22"></a><span class="dt">double</span> QWT    <span class="op">=</span> log<span class="op">(</span>WT<span class="op">/</span><span class="fl">70.0</span><span class="op">)*</span><span class="fl">0.75</span><span class="op">;</span></span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="dt">double</span> CLALB  <span class="op">=</span> log<span class="op">(</span>ALB<span class="op">/</span><span class="fl">4.5</span><span class="op">)*</span>THETA8<span class="op">;</span></span>
<span id="cb10-24"><a href="#cb10-24"></a></span>
<span id="cb10-25"><a href="#cb10-25"></a><span class="dt">double</span> KA  <span class="op">=</span> exp<span class="op">(</span>THETA1<span class="op">+</span>ETA<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb10-26"><a href="#cb10-26"></a><span class="dt">double</span> V2  <span class="op">=</span> exp<span class="op">(</span>THETA2<span class="op">+</span>V2WT<span class="op">+</span>ETA<span class="op">(</span><span class="dv">2</span><span class="op">));</span></span>
<span id="cb10-27"><a href="#cb10-27"></a><span class="dt">double</span> CL  <span class="op">=</span> exp<span class="op">(</span>THETA3<span class="op">+</span>CLWT<span class="op">+</span>CLEGFR<span class="op">+</span>CLAGE<span class="op">+</span>CLALB<span class="op">+</span>ETA<span class="op">(</span><span class="dv">3</span><span class="op">));</span></span>
<span id="cb10-28"><a href="#cb10-28"></a><span class="dt">double</span> V3  <span class="op">=</span> exp<span class="op">(</span>THETA4<span class="op">+</span>V3WT<span class="op">);</span></span>
<span id="cb10-29"><a href="#cb10-29"></a><span class="dt">double</span> Q   <span class="op">=</span> exp<span class="op">(</span>THETA5<span class="op">+</span>QWT<span class="op">);</span></span>
<span id="cb10-30"><a href="#cb10-30"></a></span>
<span id="cb10-31"><a href="#cb10-31"></a><span class="dt">double</span> S2 <span class="op">=</span> V2<span class="op">/</span><span class="fl">1000.0</span><span class="op">;</span> <span class="co">//; dose in mcg, conc in mcg/mL</span></span>
<span id="cb10-32"><a href="#cb10-32"></a></span>
<span id="cb10-33"><a href="#cb10-33"></a><span class="op">[</span> table <span class="op">]</span></span>
<span id="cb10-34"><a href="#cb10-34"></a><span class="dt">double</span> IPRED <span class="op">=</span> CENT<span class="op">/</span>S2<span class="op">;</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>capture Y <span class="op">=</span> IPRED <span class="op">*</span> <span class="op">(</span><span class="dv">1</span><span class="op">+</span>EPS<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="simulate" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Simulate</h1>
<p>Now, simulate from the mrgsolve model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim</span>(<span class="fu">zero_re</span>(mod), data, <span class="at">carry_out =</span> <span class="st">"PRED,EVID"</span>, <span class="at">digits =</span> <span class="dv">7</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">head</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID TIME EVID     PRED        GUT     CENT     PERIPH        Y
1  1 0.00    1  0.00000 5.00000000 0.000000 0.00000000  0.00000
2  1 0.61    0 60.58323 1.93352200 2.935854 0.06481082 60.58323
3  1 1.15    0 78.54761 0.83383100 3.806404 0.17738390 78.54761
4  1 1.73    0 83.03988 0.33787020 4.024099 0.31227170 83.03988
5  1 2.15    0 82.22198 0.17565080 3.984464 0.40873200 82.22198
6  1 3.19    0 75.48693 0.03476685 3.658084 0.62658760 75.48693</code></pre>
</div>
</div>
<p>Some important points to notice about this simulation</p>
<ol type="1">
<li>We wrap the model object in <code>zero_re()</code>; this drops all the random effects from the simulation so that simulated concentrations are equivalent to <code>PRED</code> regardless if we are looking at <code>DV</code> (or <code>Y</code>) or <code>IPRED</code></li>
<li>We bring <code>PRED</code> and <code>EVID</code> into the simulated output; we need <code>PRED</code> to to compare against and <code>EVID</code> is needed so we can filter out dosing records</li>
<li>We deliberately set the number of significant <code>digits</code> in the simulated result; this is really important if you want a sensitive validation index</li>
</ol>
</section>
<section id="compare" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Compare</h1>
<p>Keeping only the observation records, we make a simple summary of the difference between the prediction generated by mrgsolve (<code>Y</code>) and the value generated by NONMEM (<code>PRED</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">filter</span>(out,  EVID<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="fu">summary</span>(obs<span class="sc">$</span>Y <span class="sc">-</span> obs<span class="sc">$</span>PRED)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0       0       0       0       0       0 </code></pre>
</div>
</div>
<p>We see there is exact match up to the level of precision that we’ve requested (See <a href="2022-05-validate-translation.html#sec-appendix">Appendix</a>).</p>
<p>This can be presented graphically as well</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">plot</span>(obs<span class="sc">$</span>Y, obs<span class="sc">$</span>PRED)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2022-05-validate-translation_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we’ve looked at absolute differences between mrgsolve and NONMEM; if you do find a discrepancy, you might evaluate that as a percentage of the value of <code>PRED</code> (percent difference).</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We frequently see exact matches when models are coded with analytical solutions. This is <em>never</em> the case when coding models from ODEs. But even with ODE models you should expect to see only a small discrepancy … only a small fraction of one percent or less.</p>
</div>
</div>
</section>
<section id="complete-workflow" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Complete workflow</h1>
<p>We’ve illustrated this step by step, explaining how it works. But wanted also to show you how little code is required once you have the NONMEM and mrgsolve models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread_cache</span>(<span class="st">"106.txt"</span>)</span>
<span id="cb16-2"><a href="#cb16-2"></a>data <span class="ot">&lt;-</span> bbr<span class="sc">::</span><span class="fu">nm_join</span>(<span class="fu">here</span>(<span class="st">"model/pk/106"</span>))</span>
<span id="cb16-3"><a href="#cb16-3"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim</span>(<span class="fu">zero_re</span>(mod), data, <span class="at">carry_out =</span> <span class="st">"PRED,EVID"</span>, <span class="at">digits =</span> <span class="dv">7</span>)</span>
<span id="cb16-4"><a href="#cb16-4"></a>obs <span class="ot">&lt;-</span> <span class="fu">filter</span>(out,  EVID<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="fu">summary</span>(obs<span class="sc">$</span>Y <span class="sc">-</span> obs<span class="sc">$</span>PRED)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0       0       0       0       0       0 </code></pre>
</div>
</div>
<p>We have this done in 5 lines and objects generated from 2 of those lines will be used to run the production simulation.</p>
</section>
<section id="discussion" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Discussion</h1>
<p>It is important to note that this validation procedure only considers model <code>PRED</code> given a clinical data set. This setup evaluates dosing events, covariate effects, structural model setup and the like.</p>
<p>Note that this setup <em>does not</em> look at whether or not the random effects are coded correctly. Certainly there can be mistakes in coding the random effects, but in my experience, most errors in translation are related to input data sets, covariate models or errors with the structural model (e.g.&nbsp;coding the ODE correctly).</p>
<p>We also note how critical it is to consider the number of digits and tolerances of ODE solvers when comparing model outputs; when digits and tolerances are ignored, any discrepancy can seem bigger than it should be.</p>
<p>Finally, we include a reminder that mrgsolve is not an exact clone of NONMEM: we don’t and can’t match every behavior. So if you do find a discrepancy in your validation, it <em>could</em> be that you’ve tapped some functionality that is not consistent between NONMEM and mrgsolve. That said … I’ve been using mrgsolve with NONMEM across many years of project work and the vast majority of models we’ve worked with have matched when we are very careful in the translation and in carrying out the validation.</p>
<p>If you are unable to validate your model, please check the code. Then check it again. If you’re <em>sure</em> the model coding is equivalent and you are still seeing discrepancy, we encourage you to open ticket on our GitHub issue tracker <a href="https://github.com/metrumresearchgroup/mrgsolve/issues">here</a> so we can learn more about the discrepancy.</p>
<p>And as always, be sure to visit <a href="https://mrgsolve.or">mrgsolve.org</a> for more resources.</p>
</section>


<div id="quarto-appendix" class="default"><section id="sec-appendix" class="level1 appendix" data-number="8"><h2 class="quarto-appendix-heading"><span class="header-section-number">8</span> Appendix</h2><div class="quarto-appendix-contents">

<p>See what happens when we don’t control digits on the simulation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread_cache</span>(<span class="st">"106.txt"</span>)</span>
<span id="cb18-2"><a href="#cb18-2"></a>data <span class="ot">&lt;-</span> bbr<span class="sc">::</span><span class="fu">nm_join</span>(<span class="fu">here</span>(<span class="st">"model/pk/106"</span>))</span>
<span id="cb18-3"><a href="#cb18-3"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim</span>(<span class="fu">zero_re</span>(mod), data, <span class="at">carry_out =</span> <span class="st">"PRED,EVID"</span>)</span>
<span id="cb18-4"><a href="#cb18-4"></a>obs <span class="ot">&lt;-</span> <span class="fu">filter</span>(out,  EVID<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="fu">summary</span>(obs<span class="sc">$</span>Y <span class="sc">-</span> obs<span class="sc">$</span>PRED)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-4.952e-04 -2.714e-05 -3.701e-07 -2.581e-06  2.477e-05  4.991e-04 </code></pre>
</div>
</div>
<p>Here, we’ve used analytical solutions from both mrgsolve and NONMEM. This sort of error is what you might see when comparing two models which require ODEs to generate the solution.</p>
<p>This error is still very small relative to <code>PRED</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">summary</span>(<span class="dv">100</span><span class="sc">*</span>(obs<span class="sc">$</span>Y <span class="sc">-</span> obs<span class="sc">$</span>PRED)<span class="sc">/</span>obs<span class="sc">$</span>PRED)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-4.602e-05 -6.848e-06 -2.349e-07 -3.855e-07  6.197e-06  4.560e-05 </code></pre>
</div>
</div>


</div></section></div></main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>